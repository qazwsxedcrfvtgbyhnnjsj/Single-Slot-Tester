<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR Single Slot Tester</title>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); max-width: 800px; margin: 40px auto; padding: 20px; }
        .card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        h1 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .upload-area { border: 2px dashed #cbd5e1; padding: 2rem; border-radius: 0.5rem; text-align: center; margin: 1.5rem 0; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary); background: #f5f3ff; }
        input[type="file"] { margin-bottom: 1rem; }
        .btn { background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; width: 100%; }
        .btn:hover { opacity: 0.9; }
        #result-container { margin-top: 2rem; display: none; }
        pre { background: #0f172a; color: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; line-height: 1.5; }
        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 500; margin-bottom: 1rem; }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <div class="card">
        <h1>âš¡ FHIR å–®ç­†è½‰æ›æ¸¬è©¦å™¨</h1>
        <p>ä¸Šå‚³ CSV æª”æ¡ˆï¼Œç³»çµ±å°‡è®€å–<strong>ç¬¬ä¸€ç­†</strong>æ•¸æ“šä¸¦è½‰æ›ç‚º FHIR Slot Resourceã€‚</p>

        <div class="upload-area">
            <input type="file" id="csvFile" accept=".csv">
            <button class="btn" onclick="uploadSingle()">é–‹å§‹å–®ç­†è½‰æ›</button>
        </div>

        <div id="result-container">
            <div id="statusLabel" class="status-badge"></div>
            <div id="action-buttons" style="margin-bottom: 1rem; display: none;">
                <button class="btn" style="background: #10b981;" onclick="sendToServer()">ğŸš€ æ‰‹å‹•ä¸Šå‚³åˆ°ä¼ºæœå™¨ (203.64.84.204)</button>
            </div>
            <pre id="jsonOutput"></pre>
        </div>
    </div>

    <script>
        // ğŸ’¡ é‡è¦ï¼šåœ¨æœ€å¤–å±¤å®£å‘Šè®Šæ•¸ï¼Œé€™æ¨£æ‰€æœ‰ function éƒ½è®€å¾—åˆ°
        let currentSlotJson = null;

        async function uploadSingle() {
            const fileInput = document.getElementById('csvFile');
            const resultContainer = document.getElementById('result-container');
            const jsonOutput = document.getElementById('jsonOutput');
            const statusLabel = document.getElementById('statusLabel');
            const actionButtons = document.getElementById('action-buttons');

            if (!fileInput.files[0]) {
                alert("è«‹å…ˆé¸æ“‡ CSV æª”æ¡ˆ");
                return;
            }

         const formData = new FormData();
formData.append('file', fileInput.files[0]);

            resultContainer.style.display = 'block';
            statusLabel.className = 'status-badge';
            statusLabel.innerText = "â³ è™•ç†ä¸­...";
            jsonOutput.innerText = "æ­£åœ¨è§£æè³‡æ–™...";
            actionButtons.style.display = 'none';

            try {
                // å‘¼å«å¾Œç«¯ API (åŒ…å«è½‰æ›èˆ‡è‡ªå‹•ä¸Šå‚³)
                const response = await fetch('/api/ScheduleUpload/convert-and-upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json(); // æ”¹ç”¨ JSON è§£æ

                if (response.ok) {
                    // å¦‚æœå¾Œç«¯æœ‰å›å‚³ç”¢ç”Ÿçš„ JSON
                    currentSlotJson = JSON.parse(data.generatedJson); 
                    statusLabel.className = 'status-badge success';
                    statusLabel.innerText = "âœ… è½‰æ›æˆåŠŸ (ä¸¦å·²å˜—è©¦è‡ªå‹•ä¸Šå‚³)";
                    jsonOutput.innerText = JSON.stringify(currentSlotJson, null, 4);
                    actionButtons.style.display = 'block'; // é¡¯ç¤ºæ‰‹å‹•ä¸Šå‚³æŒ‰éˆ•ä»¥é˜²è¬ä¸€
                } else {
                    statusLabel.className = 'status-badge error';
                    statusLabel.innerText = "âŒ è™•ç†å¤±æ•—";
                    jsonOutput.innerText = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
                }
            } catch (err) {
                statusLabel.className = 'status-badge error';
                statusLabel.innerText = "ğŸ“¡ é€£ç·šéŒ¯èª¤";
                jsonOutput.innerText = "ç„¡æ³•é€£æ¥åˆ° APIï¼Œè«‹ç¢ºèªå¾Œç«¯æ˜¯å¦å·²å•Ÿå‹• (dotnet run)ã€‚";
            }
        }

        async function sendToServer() {
            if (!currentSlotJson) {
                alert("è«‹å…ˆè½‰æ› CSV å–å¾— JSON è³‡æ–™");
                return;
            }

            const fhirServerUrl = "https://tzuchi-fhir.ddns.net/fhir/Slot";

            try {
                const response = await fetch(fhirServerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(currentSlotJson)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert("âœ¨ æ‰‹å‹•ä¸Šå‚³æˆåŠŸï¼ä¼ºæœå™¨ ID: " + result.id);
                } else {
                    const errorText = await response.text();
                    alert("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + errorText);
                }
            } catch (err) {
                alert("ğŸ“¡ ç„¡æ³•é€£ç·šè‡³ FHIR Server (å¯èƒ½æ˜¯ CORS å•é¡Œï¼Œå»ºè­°ä½¿ç”¨å¾Œç«¯è‡ªå‹•ä¸Šå‚³)ã€‚");
            }
        }
    </script>
</body>
</html>